// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// =============================================
// MODEL: User (Admin & Employee Authentication)
// =============================================
model User {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  password  String
  role      Role     @default(EMPLOYEE)
  pegawai   Pegawai?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("users")
}

enum Role {
  ADMIN
  EMPLOYEE
}

// =============================================
// MODEL: Pegawai (Employee Master Data)
// =============================================
model Pegawai {
  id                Int                 @id @default(autoincrement())
  nip               String              @unique
  nama              String
  jabatan           String
  departemen        String
  jamMasuk          String              @default("08:00") // Format HH:mm
  jamPulang         String              @default("17:00") // Format HH:mm
  statusAktif       Boolean             @default(true)
  tipePembayaran    TipePembayaran      @default(TETAP)
  tarifPerJam       Int? // Tarif per jam dalam rupiah, null jika TETAP
  userId            Int?                @unique
  user              User?               @relation(fields: [userId], references: [id], onDelete: SetNull)
  absensi           Absensi[]
  requestJamBulanan RequestJamBulanan[]
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt

  @@map("pegawai")
}

// =============================================
// MODEL: Absensi (Attendance Records)
// =============================================
model Absensi {
  id            Int           @id @default(autoincrement())
  pegawaiId     Int
  pegawai       Pegawai       @relation(fields: [pegawaiId], references: [id], onDelete: Cascade)
  tanggal       DateTime      @db.DateTime
  jamMasuk      DateTime?     @db.DateTime
  jamPulang     DateTime?     @db.DateTime
  status        StatusAbsensi @default(HADIR)
  keterangan    String?       @db.Text
  terlambat     Int           @default(0) // dalam menit
  lembur        Int           @default(0) // dalam menit
  totalJamKerja Int           @default(0) // dalam menit
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  @@unique([pegawaiId, tanggal])
  @@map("absensi")
}

enum StatusAbsensi {
  HADIR
  IZIN
  SAKIT
  ALFA
}

enum TipePembayaran {
  TETAP
  PERJAM
}

enum StatusRequest {
  PENDING
  APPROVED
  REJECTED
}

// =============================================
// MODEL: HariLibur (National Holidays)
// =============================================
model HariLibur {
  id         Int      @id @default(autoincrement())
  tanggal    DateTime @unique @db.DateTime
  keterangan String
  createdAt  DateTime @default(now())

  @@map("hari_libur")
}

// =============================================
// MODEL: RequestJamBulanan (Monthly Work Hours Request)
// =============================================
model RequestJamBulanan {
  id           Int                       @id @default(autoincrement())
  pegawaiId    Int
  pegawai      Pegawai                   @relation(fields: [pegawaiId], references: [id], onDelete: Cascade)
  bulan        Int // 1-12
  tahun        Int // 2024, 2025, etc
  totalJam     Int // Total jam kerja bulan ini (calculated from details)
  deskripsi    String?                   @db.Text
  status       StatusRequest             @default(PENDING)
  alasanReject String?                   @db.Text
  approvedBy   Int? // User ID yang approve
  approvedAt   DateTime?
  details      RequestJamBulananDetail[]
  createdAt    DateTime                  @default(now())
  updatedAt    DateTime                  @updatedAt

  @@unique([pegawaiId, bulan, tahun])
  @@map("request_jam_bulanan")
}

// =============================================
// MODEL: RequestJamBulananDetail (Daily Work Hours Details)
// =============================================
model RequestJamBulananDetail {
  id          Int               @id @default(autoincrement())
  requestId   Int
  request     RequestJamBulanan @relation(fields: [requestId], references: [id], onDelete: Cascade)
  tanggal     DateTime          @db.DateTime
  jamCheckin  DateTime?         @db.DateTime // Jam check-in
  jamCheckout DateTime?         @db.DateTime // Jam check-out
  jamKerja    Float // Jam kerja dalam jam (desimal)
  deskripsi   String?           @db.Text
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  @@unique([requestId, tanggal])
  @@map("request_jam_bulanan_detail")
}
